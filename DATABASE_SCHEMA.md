# HexaBill Database Schema – Full System Reference

**Database:** PostgreSQL  
**Generated from:** EF Core model snapshot + migrations  
**Last updated:** 2026-02-21  

---

## Table of Contents

1. [Tables Overview](#tables-overview)
2. [Entity Relationship Summary](#entity-relationship-summary)
3. [Detailed Table Schemas](#detailed-table-schemas)
4. [Indexes](#indexes)
5. [Sequences](#sequences)

---

## Tables Overview

| # | Table Name | Primary Key | Description |
|---|------------|-------------|-------------|
| 1 | Tenants | Id | Multi-tenant companies |
| 2 | Users | Id | User accounts (Admin, Staff, Owner, SystemAdmin) |
| 3 | SubscriptionPlans | Id | Plans (Basic, Pro, etc.) |
| 4 | Subscriptions | Id | Tenant subscriptions |
| 5 | Branches | Id | Branch locations per tenant |
| 6 | Routes | Id | Delivery/sales routes per branch |
| 7 | BranchStaff | Id | User ↔ Branch assignment |
| 8 | RouteStaff | Id | User ↔ Route assignment |
| 9 | RouteCustomers | Id | Customer ↔ Route assignment |
| 10 | RouteExpenses | Id | Route-level expenses |
| 11 | CustomerVisits | Id | Visit records per route/customer |
| 12 | Products | Id | Product catalog |
| 13 | ProductCategories | Id | Product categories |
| 14 | PriceChangeLogs | Id | Price change audit |
| 15 | InventoryTransactions | Id | Stock movements |
| 16 | Customers | Id | Customer master |
| 17 | Sales | Id | Invoices/sales |
| 18 | SaleItems | Id | Sale line items |
| 19 | SaleReturns | Id | Sales returns |
| 20 | SaleReturnItems | Id | Return line items |
| 21 | Payments | Id | Payment records |
| 22 | PaymentIdempotencies | IdempotencyKey | Duplicate payment prevention |
| 23 | Purchases | Id | Purchase orders |
| 24 | PurchaseItems | Id | Purchase line items |
| 25 | PurchaseReturns | Id | Purchase returns |
| 26 | PurchaseReturnItems | Id | Purchase return line items |
| 27 | Expenses | Id | Expense records |
| 28 | ExpenseCategories | Id | Expense categories |
| 29 | RecurringExpenses | Id | Recurring expense templates |
| 30 | InvoiceVersions | Id | Invoice edit history |
| 31 | InvoiceTemplates | Id | Custom invoice templates |
| 32 | DamageCategories | Id | Damage types for returns |
| 33 | Settings | (Key, OwnerId) | Key-value config |
| 34 | AuditLogs | Id | Audit trail |
| 35 | Alerts | Id | System alerts |
| 36 | ErrorLogs | Id | Error records |
| 37 | HeldInvoices | Id | Draft/held invoices |
| 38 | UserSessions | Id | Active sessions |
| 39 | FailedLoginAttempts | Id | Login lockout tracking |
| 40 | DemoRequests | Id | Demo signup requests |

---

## Entity Relationship Summary

```
Tenants ─┬─ Users (TenantId)
         ├─ Branches (TenantId)
         │   ├─ Routes (BranchId)
         │   │   ├─ RouteStaff (RouteId, UserId)
         │   │   ├─ RouteCustomers (RouteId, CustomerId)
         │   │   └─ RouteExpenses (RouteId)
         │   └─ BranchStaff (BranchId, UserId)
         ├─ Customers (TenantId, BranchId?, RouteId?)
         ├─ Products (TenantId)
         ├─ ProductCategories (TenantId)
         ├─ Sales (TenantId, BranchId?, RouteId?, CustomerId?)
         │   ├─ SaleItems (SaleId, ProductId)
         │   ├─ InvoiceVersions (SaleId)
         │   └─ SaleReturns (SaleId)
         │       └─ SaleReturnItems (SaleReturnId, SaleItemId, ProductId, DamageCategoryId?)
         ├─ Payments (TenantId, SaleId?, CustomerId?)
         ├─ Expenses (TenantId, BranchId?, RouteId?)
         ├─ Subscriptions (TenantId)
         ├─ DamageCategories (TenantId)
         ├─ HeldInvoices (TenantId)
         ├─ UserSessions (TenantId)
         └─ Settings (OwnerId / TenantId)
```

---

## Detailed Table Schemas

### 1. Tenants

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| Name | varchar(200) | NO | | Company name |
| Country | varchar(10) | NO | 'AE' | |
| Currency | varchar(10) | NO | 'AED' | |
| Status | varchar | NO | 'Active' | Active, Suspended, Trial |
| Address | varchar(500) | YES | | |
| Phone | varchar(20) | YES | | |
| Email | varchar(100) | YES | | |
| Domain | varchar(200) | YES | | Unique if not null |
| Subdomain | varchar(100) | YES | | Unique if not null |
| CompanyNameEn | varchar(200) | YES | | |
| CompanyNameAr | varchar(200) | YES | | |
| VatNumber | varchar(50) | YES | | |
| LogoPath | varchar(500) | YES | | |
| TrialEndDate | timestamp with time zone | YES | | |
| SuspendedAt | timestamp with time zone | YES | | |
| SuspensionReason | varchar(500) | YES | | |
| CreatedAt | timestamp with time zone | NO | | |

---

### 2. Users

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| Name | varchar(100) | NO | | |
| Email | varchar(100) | NO | | **Unique** |
| PasswordHash | text | NO | | |
| Role | varchar | NO | | Admin, Staff, Owner, SystemAdmin |
| Phone | varchar(20) | YES | | |
| OwnerId | integer | YES | | Legacy tenant ref |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| DashboardPermissions | text | YES | | JSON |
| PageAccess | varchar(500) | YES | | |
| ProfilePhotoUrl | varchar(500) | YES | | |
| LanguagePreference | varchar(10) | YES | | |
| SessionVersion | integer | NO | | Invalidate sessions |
| CreatedAt | timestamp with time zone | NO | | |
| LastLoginAt | timestamp with time zone | YES | | |
| LastActiveAt | timestamp with time zone | YES | | |

---

### 3. SubscriptionPlans

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| Name | varchar(100) | NO | | |
| Description | varchar(500) | YES | | |
| MonthlyPrice | decimal(18,2) | NO | | |
| YearlyPrice | decimal(18,2) | NO | | |
| Currency | varchar | NO | | |
| MaxUsers | integer | NO | | |
| MaxProducts | integer | NO | | |
| MaxCustomers | integer | NO | | |
| MaxInvoicesPerMonth | integer | NO | | |
| MaxStorageMB | bigint | NO | | |
| TrialDays | integer | NO | | |
| IsActive | boolean | NO | | |
| DisplayOrder | integer | NO | | |
| HasAdvancedReports | boolean | NO | | |
| HasApiAccess | boolean | NO | | |
| HasCustomBranding | boolean | NO | | |
| HasWhiteLabel | boolean | NO | | |
| HasPrioritySupport | boolean | NO | | |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | YES | | |

---

### 4. Subscriptions

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | NO | | **FK** → Tenants.Id |
| PlanId | integer | NO | | **FK** → SubscriptionPlans.Id |
| Status | integer | NO | | Enum |
| BillingCycle | integer | NO | | Monthly, Yearly |
| Amount | decimal(18,2) | NO | | |
| Currency | varchar(10) | NO | | |
| StartDate | timestamp with time zone | NO | | |
| EndDate | timestamp with time zone | YES | | |
| TrialEndDate | timestamp with time zone | YES | | |
| NextBillingDate | timestamp with time zone | YES | | |
| ExpiresAt | timestamp with time zone | YES | | |
| PaymentMethod | varchar(50) | YES | | |
| PaymentGatewayCustomerId | varchar(200) | YES | | |
| PaymentGatewaySubscriptionId | varchar(200) | YES | | |
| CancelledAt | timestamp with time zone | YES | | |
| CancellationReason | varchar(500) | YES | | |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | YES | | |

---

### 5. Branches

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | NO | | **FK** → Tenants.Id |
| Name | varchar(200) | NO | | |
| Address | varchar(500) | YES | | |
| Location | varchar(200) | YES | | |
| ManagerId | integer | YES | | **FK** → Users.Id |
| ManagerUserId | integer | YES | | **FK** → Users.Id |
| IsActive | boolean | NO | | |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | YES | | |

---

### 6. Routes

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| BranchId | integer | NO | | **FK** → Branches.Id |
| TenantId | integer | NO | | **FK** → Tenants.Id |
| Name | varchar(200) | NO | | |
| AssignedStaffId | integer | YES | | **FK** → Users.Id (legacy) |
| IsActive | boolean | NO | | |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | YES | | |

---

### 7. BranchStaff

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| BranchId | integer | NO | | **FK** → Branches.Id |
| UserId | integer | NO | | **FK** → Users.Id |
| AssignedAt | timestamp with time zone | NO | | |
| **Unique** | (BranchId, UserId) | | | |

---

### 8. RouteStaff

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| RouteId | integer | NO | | **FK** → Routes.Id |
| UserId | integer | NO | | **FK** → Users.Id |
| AssignedAt | timestamp with time zone | NO | | |
| **Unique** | (RouteId, UserId) | | | |

---

### 9. RouteCustomers

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| RouteId | integer | NO | | **FK** → Routes.Id |
| CustomerId | integer | NO | | **FK** → Customers.Id |
| AssignedAt | timestamp with time zone | NO | | |
| **Unique** | (RouteId, CustomerId) | | | |

---

### 10. RouteExpenses

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| RouteId | integer | NO | | **FK** → Routes.Id |
| TenantId | integer | NO | | **FK** → Tenants.Id |
| Amount | decimal(18,2) | NO | | |
| Category | text | NO | | |
| Description | varchar(500) | YES | | |
| ExpenseDate | timestamp with time zone | NO | | |
| CreatedBy | integer | NO | | **FK** → Users.Id |
| CreatedAt | timestamp with time zone | NO | | |

---

### 11. CustomerVisits

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| RouteId | integer | NO | | **FK** → Routes.Id |
| CustomerId | integer | NO | | **FK** → Customers.Id |
| TenantId | integer | NO | | **FK** → Tenants.Id |
| StaffId | integer | YES | | **FK** → Users.Id |
| VisitDate | timestamp with time zone | NO | | |
| Status | varchar | NO | 'NotVisited' | NotVisited, Visited, etc. |
| AmountCollected | decimal(18,2) | YES | | |
| PaymentCollected | decimal(18,2) | YES | | |
| Notes | varchar(500) | YES | | |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | YES | | |
| **Unique** | (RouteId, CustomerId, VisitDate) | | | |

---

### 12. Products

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| OwnerId | integer | NO | | Legacy tenant |
| Sku | varchar(50) | NO | | **Unique** (TenantId, Sku) |
| Barcode | varchar(100) | YES | | |
| NameEn | varchar(200) | NO | | |
| NameAr | varchar(200) | YES | | |
| DescriptionEn | text | YES | | |
| DescriptionAr | text | YES | | |
| CategoryId | integer | YES | | **FK** → ProductCategories.Id |
| UnitType | varchar(20) | NO | | CRTN, PIECE, etc. |
| ConversionToBase | numeric(18,2) | NO | | |
| CostPrice | numeric(18,2) | NO | | |
| SellPrice | numeric(18,2) | NO | | |
| StockQty | numeric(18,2) | NO | | |
| ReorderLevel | integer | NO | | |
| ExpiryDate | timestamp with time zone | YES | | |
| ImageUrl | varchar(500) | YES | | |
| IsActive | boolean | NO | | |
| RowVersion | bytea | NO | | Concurrency token |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | NO | | |

---

### 13. ProductCategories

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| Name | varchar(100) | NO | | **Unique** (TenantId, Name) |
| Description | varchar(200) | YES | | |
| ColorCode | varchar(7) | NO | | |
| IsActive | boolean | NO | | |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | NO | | |

---

### 14. PriceChangeLogs

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| ProductId | integer | NO | | **FK** → Products.Id |
| OldPrice | decimal(18,2) | NO | | |
| NewPrice | decimal(18,2) | NO | | |
| PriceDifference | decimal(18,2) | NO | | |
| ChangedBy | integer | NO | | **FK** → Users.Id |
| ChangedAt | timestamp with time zone | NO | | |
| Reason | varchar(500) | YES | | |
| OwnerId | integer | NO | | Legacy |
| TenantId | integer | YES | | **FK** → Tenants.Id |

---

### 15. InventoryTransactions

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| ProductId | integer | NO | | **FK** → Products.Id |
| ChangeQty | decimal(18,2) | NO | | +/– |
| TransactionType | text | NO | | Sale, Purchase, Return, etc. |
| Reason | text | YES | | |
| RefId | integer | YES | | Related Sale/Purchase Id |
| OwnerId | integer | NO | | Legacy |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| CreatedAt | timestamp with time zone | NO | | |

---

### 16. Customers

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| OwnerId | integer | NO | | Legacy |
| Name | varchar(200) | NO | | |
| Phone | varchar(20) | YES | | |
| Email | varchar(100) | YES | | |
| Trn | varchar(50) | YES | | Tax reg no |
| Address | varchar(500) | YES | | |
| CustomerType | integer | NO | | 0=Credit, 1=Cash |
| CreditLimit | decimal(18,2) | NO | 0 | |
| PaymentTerms | varchar(100) | YES | | |
| Balance | decimal(18,2) | NO | 0 | Computed/cached |
| PendingBalance | decimal(18,2) | NO | 0 | Unpaid sales |
| TotalSales | decimal(18,2) | NO | 0 | |
| TotalPayments | decimal(18,2) | NO | 0 | |
| BranchId | integer | YES | | **FK** → Branches.Id |
| RouteId | integer | YES | | **FK** → Routes.Id |
| LastActivity | timestamp with time zone | YES | | |
| LastPaymentDate | timestamp with time zone | YES | | |
| RowVersion | bytea | NO | | Concurrency |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | NO | | |

---

### 17. Sales

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| OwnerId | integer | NO | | Legacy |
| InvoiceNo | varchar(100) | NO | | **Unique** (OwnerId, InvoiceNo) when !IsDeleted |
| InvoiceDate | timestamp with time zone | NO | | |
| DueDate | timestamp with time zone | YES | | |
| CustomerId | integer | YES | | **FK** → Customers.Id |
| BranchId | integer | YES | | **FK** → Branches.Id |
| RouteId | integer | YES | | **FK** → Routes.Id |
| Subtotal | decimal(18,2) | NO | | |
| Discount | decimal(18,2) | NO | | |
| VatTotal | decimal(18,2) | NO | | |
| TotalAmount | decimal(18,2) | NO | | |
| GrandTotal | decimal(18,2) | NO | | |
| PaidAmount | decimal(18,2) | NO | 0 | |
| PaymentStatus | varchar | NO | | Pending, Partial, Paid |
| IsDeleted | boolean | NO | false | Soft delete |
| IsLocked | boolean | NO | false | |
| IsFinalized | boolean | NO | | |
| Notes | text | YES | | |
| ExternalReference | varchar(200) | YES | | **Unique** if not null |
| Version | integer | NO | 1 | Optimistic locking |
| RowVersion | bytea | NO | | Concurrency |
| CreatedBy | integer | NO | | **FK** → Users.Id |
| CreatedAt | timestamp with time zone | NO | | |
| LastModifiedBy | integer | YES | | **FK** → Users.Id |
| LastModifiedAt | timestamp with time zone | YES | | |
| DeletedBy | integer | YES | | **FK** → Users.Id |
| DeletedAt | timestamp with time zone | YES | | |
| LockedAt | timestamp with time zone | YES | | |
| LastPaymentDate | timestamp with time zone | YES | | |
| EditReason | varchar(500) | YES | | |

---

### 18. SaleItems

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| SaleId | integer | NO | | **FK** → Sales.Id |
| ProductId | integer | NO | | **FK** → Products.Id |
| UnitType | varchar(20) | NO | | |
| Qty | decimal(18,2) | NO | | |
| UnitPrice | decimal(18,2) | NO | | |
| Discount | decimal(18,2) | NO | | |
| VatAmount | decimal(18,2) | NO | | |
| LineTotal | decimal(18,2) | NO | | |

---

### 19. SaleReturns

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| OwnerId | integer | NO | | Legacy |
| SaleId | integer | NO | | **FK** → Sales.Id |
| ReturnNo | varchar(100) | NO | | **Unique** |
| ReturnDate | timestamp with time zone | NO | | |
| ReturnType | varchar(20) | YES | | |
| CustomerId | integer | YES | | **FK** → Customers.Id |
| BranchId | integer | YES | | **FK** → Branches.Id |
| RouteId | integer | YES | | **FK** → Routes.Id |
| Subtotal | decimal(18,2) | NO | | |
| Discount | decimal(18,2) | NO | | |
| VatTotal | decimal(18,2) | NO | | |
| GrandTotal | decimal(18,2) | NO | | |
| Status | varchar | NO | | |
| RestoreStock | boolean | NO | | |
| IsBadItem | boolean | NO | | |
| Reason | varchar(500) | YES | | |
| CreatedBy | integer | NO | | **FK** → Users.Id |
| CreatedAt | timestamp with time zone | NO | | |

---

### 20. SaleReturnItems

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| SaleReturnId | integer | NO | | **FK** → SaleReturns.Id |
| SaleItemId | integer | NO | | **FK** → SaleItems.Id |
| ProductId | integer | NO | | **FK** → Products.Id |
| DamageCategoryId | integer | YES | | **FK** → DamageCategories.Id |
| UnitType | varchar(20) | NO | | |
| Qty | decimal(18,2) | NO | | |
| UnitPrice | decimal(18,2) | NO | | |
| VatAmount | decimal(18,2) | NO | | |
| LineTotal | decimal(18,2) | NO | | |
| Reason | varchar(200) | YES | | |
| StockEffect | boolean | YES | | Add back to stock? |

---

### 21. Payments

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| OwnerId | integer | NO | | Legacy |
| SaleId | integer | YES | | **FK** → Sales.Id |
| CustomerId | integer | YES | | **FK** → Customers.Id |
| Amount | decimal(18,2) | NO | | |
| Mode | varchar | NO | | Cash, Cheque, etc. |
| PaymentDate | timestamp with time zone | NO | | |
| Status | varchar | NO | | |
| Reference | varchar(200) | YES | | |
| CreatedBy | integer | NO | | **FK** → Users.Id |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | YES | | |
| RowVersion | bytea | NO | | Concurrency |

---

### 22. PaymentIdempotencies

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **IdempotencyKey** | varchar(100) | NO | | **PK** |
| PaymentId | integer | NO | | **FK** → Payments.Id |
| UserId | integer | NO | | **FK** → Users.Id |
| ResponseSnapshot | text | YES | | |
| CreatedAt | timestamp with time zone | NO | | |

---

### 23. Purchases

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| OwnerId | integer | NO | | Legacy |
| InvoiceNo | varchar(100) | NO | | **Unique** (OwnerId, InvoiceNo) |
| PurchaseDate | timestamp with time zone | NO | | |
| SupplierName | varchar(200) | NO | | |
| TotalAmount | decimal(18,2) | NO | | |
| Subtotal | decimal(18,2) | YES | | |
| VatTotal | decimal(18,2) | YES | | |
| ExternalReference | varchar(200) | YES | | |
| ExpenseCategory | varchar(100) | YES | | |
| InvoiceFilePath | varchar(500) | YES | | |
| InvoiceFileName | varchar(255) | YES | | |
| CreatedBy | integer | NO | | **FK** → Users.Id |
| CreatedAt | timestamp with time zone | NO | | |

---

### 24. PurchaseItems

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| PurchaseId | integer | NO | | **FK** → Purchases.Id |
| ProductId | integer | NO | | **FK** → Products.Id |
| UnitType | varchar(20) | NO | | |
| Qty | decimal(18,2) | NO | | |
| UnitCost | decimal(18,2) | NO | | |
| UnitCostExclVat | decimal(18,2) | YES | | |
| VatAmount | decimal(18,2) | YES | | |
| LineTotal | decimal(18,2) | NO | | |

---

### 25. PurchaseReturns

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| OwnerId | integer | NO | | Legacy |
| PurchaseId | integer | NO | | **FK** → Purchases.Id |
| ReturnNo | varchar(100) | NO | | **Unique** |
| ReturnDate | timestamp with time zone | NO | | |
| SupplierId | integer | YES | | |
| Subtotal | decimal(18,2) | NO | | |
| VatTotal | decimal(18,2) | NO | | |
| GrandTotal | decimal(18,2) | NO | | |
| Status | varchar | NO | | |
| Reason | varchar(500) | YES | | |
| CreatedBy | integer | NO | | **FK** → Users.Id |
| CreatedAt | timestamp with time zone | NO | | |

---

### 26. PurchaseReturnItems

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| PurchaseReturnId | integer | NO | | **FK** → PurchaseReturns.Id |
| PurchaseItemId | integer | NO | | **FK** → PurchaseItems.Id |
| ProductId | integer | NO | | **FK** → Products.Id |
| UnitType | varchar(20) | NO | | |
| Qty | decimal(18,2) | NO | | |
| UnitCost | decimal(18,2) | NO | | |
| LineTotal | decimal(18,2) | NO | | |
| Reason | varchar(200) | YES | | |

---

### 27. Expenses

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| OwnerId | integer | NO | | Legacy |
| CategoryId | integer | NO | | **FK** → ExpenseCategories.Id |
| Amount | decimal(18,2) | NO | | |
| Date | timestamp with time zone | NO | | |
| Note | varchar(500) | YES | | |
| BranchId | integer | YES | | **FK** → Branches.Id |
| RouteId | integer | YES | | **FK** → Routes.Id |
| RecurringExpenseId | integer | YES | | **FK** → RecurringExpenses.Id |
| Status | integer | NO | | Draft, Approved, Rejected |
| ApprovedBy | integer | YES | | **FK** → Users.Id |
| ApprovedAt | timestamp with time zone | YES | | |
| RejectionReason | varchar(500) | YES | | |
| AttachmentUrl | varchar(500) | YES | | |
| CreatedBy | integer | NO | | **FK** → Users.Id |
| CreatedAt | timestamp with time zone | NO | | |

---

### 28. ExpenseCategories

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| Name | varchar(100) | NO | | **Unique** |
| ColorCode | varchar(7) | NO | | |
| IsActive | boolean | NO | | |
| CreatedAt | timestamp with time zone | NO | | |

---

### 29. RecurringExpenses

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| OwnerId | integer | NO | | Legacy |
| CategoryId | integer | NO | | **FK** → ExpenseCategories.Id |
| Amount | decimal(18,2) | NO | | |
| Frequency | integer | NO | | Daily, Weekly, Monthly |
| DayOfRecurrence | integer | YES | | Day of month |
| StartDate | timestamp with time zone | NO | | |
| EndDate | timestamp with time zone | YES | | |
| Note | varchar(500) | YES | | |
| BranchId | integer | YES | | **FK** → Branches.Id |
| IsActive | boolean | NO | | |
| CreatedBy | integer | NO | | **FK** → Users.Id (legacy) |
| CreatedByUserId | integer | NO | | **FK** → Users.Id |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | YES | | |

---

### 30. InvoiceVersions

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| SaleId | integer | NO | | **FK** → Sales.Id |
| VersionNumber | integer | NO | | |
| DataJson | text | NO | | Snapshot |
| DiffSummary | varchar(1000) | YES | | |
| EditReason | varchar(500) | YES | | |
| CreatedById | integer | NO | | **FK** → Users.Id |
| OwnerId | integer | NO | | Legacy |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| CreatedAt | timestamp with time zone | NO | | |

---

### 31. InvoiceTemplates

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| Name | varchar(200) | NO | | |
| Description | varchar(1000) | YES | | |
| HtmlCode | text | NO | | |
| CssCode | text | YES | | |
| Version | varchar(50) | NO | | |
| IsActive | boolean | NO | | |
| CreatedBy | integer | NO | | **FK** → Users.Id |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | YES | | |

---

### 32. DamageCategories

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | NO | | **FK** → Tenants.Id |
| Name | varchar(100) | NO | | |
| AffectsStock | boolean | NO | | |
| AffectsLedger | boolean | NO | | |
| IsResaleable | boolean | NO | | |
| SortOrder | integer | NO | | |
| CreatedAt | timestamp with time zone | NO | | |

---

### 33. Settings

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Key** | varchar(100) | NO | | **PK** (composite) |
| **OwnerId** | integer | NO | | **PK** (composite) |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| Value | text | YES | | |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | NO | | |

---

### 34. AuditLogs

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| OwnerId | integer | NO | | Legacy |
| UserId | integer | NO | | **FK** → Users.Id |
| Action | varchar(200) | NO | | |
| Details | text | YES | | |
| EntityType | varchar(100) | YES | | |
| EntityId | integer | YES | | |
| OldValues | text | YES | | |
| NewValues | text | YES | | |
| IpAddress | varchar(45) | YES | | |
| CreatedAt | timestamp with time zone | NO | | |

---

### 35. Alerts

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| OwnerId | integer | NO | | 0 = system |
| Title | varchar(200) | NO | | |
| Message | varchar(2000) | YES | | |
| Type | varchar(100) | NO | | |
| Severity | varchar(50) | NO | | |
| Metadata | varchar(500) | YES | | |
| IsRead | boolean | NO | | |
| IsResolved | boolean | NO | | |
| ReadAt | timestamp with time zone | YES | | |
| ResolvedAt | timestamp with time zone | YES | | |
| ResolvedBy | integer | YES | | **FK** → Users.Id |
| CreatedAt | timestamp with time zone | NO | | |

---

### 36. ErrorLogs

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | YES | | **FK** → Tenants.Id |
| UserId | integer | YES | | **FK** → Users.Id |
| TraceId | varchar(64) | NO | | |
| ErrorCode | varchar(64) | NO | | |
| Message | varchar(2000) | NO | | |
| StackTrace | text | YES | | |
| Path | varchar(500) | YES | | |
| Method | varchar(16) | YES | | |
| ResolvedAt | timestamp with time zone | YES | | |
| CreatedAt | timestamp with time zone | NO | | |

---

### 37. HeldInvoices

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| TenantId | integer | NO | | **FK** → Tenants.Id |
| UserId | integer | NO | | **FK** → Users.Id |
| Name | varchar(200) | NO | | |
| InvoiceData | text | NO | | JSON |
| CreatedAt | timestamp with time zone | NO | | |

---

### 38. UserSessions

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| UserId | integer | NO | | **FK** → Users.Id |
| TenantId | integer | NO | | **FK** → Tenants.Id |
| LoginAt | timestamp with time zone | NO | | |
| IpAddress | varchar(45) | YES | | |
| UserAgent | varchar(500) | YES | | |

---

### 39. FailedLoginAttempts

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| Email | varchar(100) | NO | | **Unique** (normalized) |
| FailedCount | integer | NO | 1 | |
| LastAttemptAt | timestamp with time zone | NO | | |
| LockoutUntil | timestamp with time zone | YES | | |
| CreatedAt | timestamp with time zone | NO | | |
| UpdatedAt | timestamp with time zone | YES | | |

---

### 40. DemoRequests

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| **Id** | integer | NO | GENERATED BY DEFAULT AS IDENTITY | **PK** |
| CompanyName | varchar(200) | NO | | |
| ContactName | varchar(100) | NO | | |
| Email | varchar(100) | NO | | |
| Phone | varchar(20) | NO | | WhatsApp |
| Country | varchar(10) | NO | | |
| Industry | varchar(100) | NO | | |
| MonthlySalesRange | varchar(50) | NO | | |
| StaffCount | integer | NO | | |
| Status | varchar | NO | | Pending, Approved, Rejected |
| CreatedTenantId | integer | YES | | **FK** → Tenants.Id (if approved) |
| AssignedPlanId | integer | YES | | **FK** → SubscriptionPlans.Id |
| ProcessedAt | timestamp with time zone | YES | | |
| ProcessedByUserId | integer | YES | | **FK** → Users.Id |
| RejectionReason | varchar(500) | YES | | |
| CreatedAt | timestamp with time zone | NO | | |

---

## Sequences (PostgreSQL)

| Sequence | Used By | Purpose |
|----------|---------|---------|
| invoice_number_seq | (application) | Invoice number generation (starts at 2000) |
| "Tenants_Id_seq" | Tenants.Id | Identity |
| "Users_Id_seq" | Users.Id | Identity |
| "BranchStaff_Id_seq" | BranchStaff.Id | Identity |
| "RouteStaff_Id_seq" | RouteStaff.Id | Identity |
| "RouteCustomers_Id_seq" | RouteCustomers.Id | Identity |
| "RouteExpenses_Id_seq" | RouteExpenses.Id | Identity |
| "CustomerVisits_Id_seq" | CustomerVisits.Id | Identity |
| "UserSessions_Id_seq" | UserSessions.Id | Identity |
| "RecurringExpenses_Id_seq" | RecurringExpenses.Id | Identity |
| "DamageCategories_Id_seq" | DamageCategories.Id | Identity |
| "ProductCategories_Id_seq" | ProductCategories.Id | Identity |
| "HeldInvoices_Id_seq" | HeldInvoices.Id | Identity |
| "FailedLoginAttempts_Id_seq" | FailedLoginAttempts.Id | Identity |

---

## Notes

- **OwnerId** = legacy tenant/owner reference; **TenantId** = current multi-tenant field. Use TenantId for new logic.
- **PostgreSQL types**: `INTEGER` → `integer`, `TEXT` → `text`, `BLOB` → `bytea`, `decimal(18,2)` → `numeric(18,2)`, `timestamp` → `timestamp with time zone`.
- Tables with `UseIdentityByDefaultColumn` use `GENERATED BY DEFAULT AS IDENTITY` on PostgreSQL.
- Unique constraints and indexes are defined per table in AppDbContext and migrations.
